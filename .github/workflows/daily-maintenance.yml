name: Daily Article Maintenance Check

on:
  schedule:
    # æ¯æ—¥ AM3:00 (JST) = æ¯æ—¥ PM6:00 (UTC) ã«å®Ÿè¡Œï¼ˆæœˆæ›œã¯è¨˜äº‹ç”Ÿæˆã®1æ™‚é–“å¾Œï¼‰
    - cron: '0 18 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
    inputs:
      force_run:
        description: "Force run even if it ran within 24h"
        required: false
        default: false
        type: boolean

concurrency:
  group: repo-write-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  safety-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      should_run: ${{ steps.safety.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check last run timestamp (24h safety)
        id: safety
        env:
          FORCE_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_run || 'false' }}
        run: |
          LAST_RUN_FILE=".github/last_run_timestamp"
          NOW_TS=$(date +%s)
          SHOULD_RUN=true

          if [ "$FORCE_RUN" = "true" ]; then
            echo "Force run requested (workflow_dispatch). Skipping 24h safety guard."
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "$NOW_TS" > "$LAST_RUN_FILE"
            exit 0
          fi

          if [ -f "$LAST_RUN_FILE" ]; then
            LAST_RUN_TS="$(cat "$LAST_RUN_FILE" | tr -d '\n\r' || true)"
            if [[ "$LAST_RUN_TS" =~ ^[0-9]+$ ]]; then
              ELAPSED=$(( NOW_TS - LAST_RUN_TS ))
              if [ "$ELAPSED" -lt 86400 ]; then
                echo "This workflow ran less than 24 hours ago (${ELAPSED}s). Skipping to save API cost."
                SHOULD_RUN=false
              fi
            else
              echo "WARN: last_run_timestamp is missing/invalid; continuing."
            fi
          fi

          echo "should_run=$SHOULD_RUN" >> "$GITHUB_OUTPUT"
          if [ "$SHOULD_RUN" = "false" ]; then
            exit 0
          fi

          echo "$NOW_TS" > "$LAST_RUN_FILE"

      - name: Commit timestamp file
        uses: stefanzweifel/git-auto-commit-action@v5
        if: steps.safety.outputs.should_run == 'true'
        with:
          commit_message: "chore: update last_run_timestamp for safety check"
          file_pattern: ".github/last_run_timestamp"

  main:
    runs-on: ubuntu-latest
    needs: safety-check
    if: needs.safety-check.outputs.should_run == 'true'
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: CI -> fail if NPM_CONFIG_PRODUCTION=true
        run: |
          if [ "${NPM_CONFIG_PRODUCTION:-false}" = "true" ]; then
            echo "ERROR: NPM_CONFIG_PRODUCTION=true will skip devDependencies; set NPM_CONFIG_PRODUCTION=false or use npm ci --include=dev.";
            exit 1;
          fi

      - name: Install dependencies (include dev)
        run: npm ci --include=dev

      - name: Analytics health check (GA4/GSC)
        id: analytics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/analytics-health-check.cjs

      - name: Run maintenance script - Metadata autofix (always)
        env:
          SANITY_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
          SANITY_DATASET: ${{ secrets.SANITY_DATASET }}
          SANITY_API_VERSION: ${{ secrets.SANITY_API_VERSION }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
          MAINTENANCE_METADATA_ONLY: "1"
          MAINTENANCE_ASSERT_METADATA: "1"
        run: |
          echo "=== ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è£œå®Œï¼ˆã‚«ãƒ†ã‚´ãƒª/ã‚¿ã‚°/æŠœç²‹/SEOï¼‰é–‹å§‹ ==="
          node scripts/maintenance.js autofix

      - name: Revenue optimize - Ensure comparison links for é€€è·/è»¢è· categories
        env:
          SANITY_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
          SANITY_DATASET: ${{ secrets.SANITY_DATASET }}
          SANITY_API_VERSION: ${{ secrets.SANITY_API_VERSION }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
        run: |
          echo "=== åç›Šæœ€é©åŒ–ãƒªãƒ³ã‚¯è£œå®Œï¼ˆé€€è·/è»¢è·ã‚«ãƒ†ã‚´ãƒªï¼‰é–‹å§‹ ==="
          node scripts/maintenance.js revenue-links

      - name: Create issue if problems found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const date = new Date().toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo' });

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹] è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡Œã‚’æ¤œå‡º (${date})`,
              body: `## è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯çµæœ\n\nå®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\nè©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n${context.payload.repository.html_url}/actions/runs/${context.runId}\n\n---\n**å®Ÿè¡Œæ™‚åˆ»**: ${date}\n**ãƒã‚§ãƒƒã‚¯é …ç›®**:\n- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (Slug, Categories)\n- SEO (Meta Description: 120-160æ–‡å­—)\n- æ¨å¥¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (Tags, Excerpt)\n- æ–‡å­—æ•° (æ¨å¥¨2000æ–‡å­—ä»¥ä¸Š)\n- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³`,
              labels: ['maintenance', 'article-quality']
            });

      - name: Post summary
        if: always()
        run: |
          echo "âœ… ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "ğŸ“Š å®Ÿè¡Œæ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
