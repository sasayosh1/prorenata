name: Daily Article Maintenance Check

on:
  schedule:
    # æœˆãƒ»æ°´ãƒ»é‡‘ã®PM6:00 (UTC) = æ—¥æœ¬æ™‚é–“AM3:00ã«å®Ÿè¡Œ
    - cron: '0 18 * * 1,3,5'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

jobs:
  maintenance_check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run maintenance script - All checks
        run: |
          echo "=== è¨˜äº‹å“è³ªãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯é–‹å§‹ ==="
          SANITY_API_TOKEN=${{ secrets.SANITY_API_TOKEN }} node scripts/maintenance.js all
        continue-on-error: true

      - name: Create issue if problems found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const date = new Date().toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo' });

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹] è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡Œã‚’æ¤œå‡º (${date})`,
              body: `## è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯çµæœ\n\nå®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\nè©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n${context.payload.repository.html_url}/actions/runs/${context.runId}\n\n---\n**å®Ÿè¡Œæ™‚åˆ»**: ${date}\n**ãƒã‚§ãƒƒã‚¯é …ç›®**:\n- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (Slug, Categories)\n- SEO (Meta Description: 120-160æ–‡å­—)\n- æ¨å¥¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (Tags, Excerpt)\n- æ–‡å­—æ•° (æ¨å¥¨2000æ–‡å­—ä»¥ä¸Š)\n- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³`,
              labels: ['maintenance', 'article-quality']
            });

      - name: Post summary
        if: always()
        run: |
          echo "âœ… ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "ğŸ“Š å®Ÿè¡Œæ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
