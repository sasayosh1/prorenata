name: Daily Article Maintenance Check

on:
  schedule:
    # æ¯æ—¥ AM3:00 (JST) = æ¯æ—¥ PM6:00 (UTC) ã«å®Ÿè¡Œï¼ˆæœˆæ›œã¯è¨˜äº‹ç”Ÿæˆã®1æ™‚é–“å¾Œï¼‰
    - cron: '0 18 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

jobs:
  maintenance_check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run maintenance script - All checks and auto-fix
        env:
          SANITY_API_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
        run: |
          echo "=== ç·åˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é–‹å§‹ï¼ˆæ¤œå‡ºï¼‹è‡ªå‹•ä¿®æ­£ï¼‰ ==="
          node scripts/maintenance.js all

      - name: Create issue if problems found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const date = new Date().toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo' });

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹] è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡Œã‚’æ¤œå‡º (${date})`,
              body: `## è¨˜äº‹å“è³ªãƒã‚§ãƒƒã‚¯çµæœ\n\nå®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\nè©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„:\n${context.payload.repository.html_url}/actions/runs/${context.runId}\n\n---\n**å®Ÿè¡Œæ™‚åˆ»**: ${date}\n**ãƒã‚§ãƒƒã‚¯é …ç›®**:\n- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (Slug, Categories)\n- SEO (Meta Description: 120-160æ–‡å­—)\n- æ¨å¥¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (Tags, Excerpt)\n- æ–‡å­—æ•° (æ¨å¥¨2000æ–‡å­—ä»¥ä¸Š)\n- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³`,
              labels: ['maintenance', 'article-quality']
            });

      - name: Post summary
        if: always()
        run: |
          echo "âœ… ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "ğŸ“Š å®Ÿè¡Œæ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
