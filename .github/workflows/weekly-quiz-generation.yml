name: ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºè‡ªå‹•ç”Ÿæˆ

on:
  schedule:
    # æ¯æ—¥ æ·±å¤œ2:00 JST (17:00 UTCå‰æ—¥) ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write
  issues: write

jobs:
  generate-quiz-term:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: CI -> fail if NPM_CONFIG_PRODUCTION=true
        run: |
          if [ "${NPM_CONFIG_PRODUCTION:-false}" = "true" ]; then
            echo "ERROR: NPM_CONFIG_PRODUCTION=true will skip devDependencies. Set NPM_CONFIG_PRODUCTION=false or use npm ci --include=dev.";
            exit 1;
          fi

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (include dev)
        # Ensure devDependencies are installed for scripts that might expect them
        run: npm ci --include=dev

      - name: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºå•é¡Œã‚’ç”Ÿæˆ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node scripts/generate-quiz-term.cjs

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git add src/data/medical-terms.ts

          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãŒãªã„ãŸã‚ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºå•é¡Œã‚’è‡ªå‹•ç”Ÿæˆ" \
              -m "" \
              -m "ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" \
              -m "" \
              -m "Co-Authored-By: Claude <noreply@anthropic.com>"
            git pull --rebase origin main
            git push
            echo "âœ… æ–°ã—ã„ã‚¯ã‚¤ã‚ºå•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          fi

      - name: ã‚¨ãƒ©ãƒ¼æ™‚ã«GitHub Issueä½œæˆ
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºè‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
              body: `ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºã®è‡ªå‹•ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚\n\n- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n- ãƒ–ãƒ©ãƒ³ãƒ: ${context.ref}\n- ã‚³ãƒŸãƒƒãƒˆ: ${context.sha}\n\nã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
              labels: ['bug', 'automated']
            });
