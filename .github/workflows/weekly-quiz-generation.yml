name: ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºè‡ªå‹•ç”Ÿæˆ

on:
#   schedule:
#     # æ¯æ—¥ æ·±å¤œ2:15 JST (17:15 UTCå‰æ—¥) ã«å®Ÿè¡Œï¼ˆè¨˜äº‹ç”Ÿæˆã¨åŒæ™‚åˆ»ã‚’é¿ã‘ã‚‹ï¼‰
#     - cron: '15 17 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

concurrency:
  group: repo-write-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  generate-quiz-term:
    runs-on: ubuntu-latest
    env:
      GEMINI_BUDGET_JPY: '300'

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: CI -> fail if NPM_CONFIG_PRODUCTION=true
        run: |
          if [ "${NPM_CONFIG_PRODUCTION:-false}" = "true" ]; then
            echo "ERROR: NPM_CONFIG_PRODUCTION=true will skip devDependencies. Set NPM_CONFIG_PRODUCTION=false or use npm ci --include=dev.";
            exit 1;
          fi

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (include dev)
        # Ensure devDependencies are installed for scripts that might expect them
        run: npm ci --include=dev

      - name: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Analytics health check (GA4/GSC)
        id: analytics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/analytics-health-check.cjs

      - name: Determine budget month (UTC)
        if: steps.analytics.outputs.healthy == 'true'
        id: budget_month
        run: echo "month=$(date -u +%Y-%m)" >> "$GITHUB_OUTPUT"

      - name: Cache Gemini budget state
        if: steps.analytics.outputs.healthy == 'true'
        uses: actions/cache@v4
        with:
          path: .budget
          key: gemini-budget-${{ runner.os }}-${{ github.repository }}-${{ steps.budget_month.outputs.month }}-${{ github.run_id }}
          restore-keys: |
            gemini-budget-${{ runner.os }}-${{ github.repository }}-${{ steps.budget_month.outputs.month }}-
            gemini-budget-${{ runner.os }}-${{ github.repository }}-

      - name: Budget guard (pre-check)
        if: steps.analytics.outputs.healthy == 'true'
        id: budget
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/budget-guard.cjs --reserve-jpy 0.05

      - name: ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºå•é¡Œã‚’ç”Ÿæˆ
        if: steps.analytics.outputs.healthy == 'true' && steps.budget.outputs.allowed == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node scripts/generate-quiz-term.cjs

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          # ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆæœªã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ›´ã«ã‚ˆã‚‹pullå¤±æ•—ã‚’é˜²ãï¼‰
          git add -A

          # å·®åˆ†ãŒãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
          if git diff --cached --quiet; then
            echo "å¤‰æ›´ãŒãªã„ãŸã‚ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºå•é¡Œã‚’è‡ªå‹•ç”Ÿæˆ" \
              -m "" \
              -m "ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" \
              -m "" \
              -m "Co-Authored-By: Claude <noreply@anthropic.com>"
            # pullæ™‚ã«æ®‹å·®åˆ†ã§å¤±æ•—ã—ãªã„ã‚ˆã† autostash ã‚’æœ‰åŠ¹åŒ–
            git pull --rebase --autostash origin main
            git push
            echo "âœ… æ–°ã—ã„ã‚¯ã‚¤ã‚ºå•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          fi

      - name: ã‚¨ãƒ©ãƒ¼æ™‚ã«GitHub Issueä½œæˆ
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºè‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
              body: `ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¯ã‚¤ã‚ºã®è‡ªå‹•ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚\n\n- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n- ãƒ–ãƒ©ãƒ³ãƒ: ${context.ref}\n- ã‚³ãƒŸãƒƒãƒˆ: ${context.sha}\n\nã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
              labels: ['bug', 'automated']
            });
