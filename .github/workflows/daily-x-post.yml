name: Daily X Auto Post

on:
  schedule:
    # 毎日PM8:30頃 (JST) = PM11:30 (UTC) に起動
    # スクリプト内で0〜60分のランダム待機後に投稿（実質PM8:30〜9:30の間）
    - cron: '30 11 * * *'
  workflow_dispatch: # 手動実行も可能にする

jobs:
  post_to_x:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Generate X summary text
        run: node scripts/auto-post-to-x.js
        env:
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Append summary to Issue
        if: always() && vars.X_SUMMARY_ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        env:
          SUMMARY_ISSUE_NUMBER: ${{ vars.X_SUMMARY_ISSUE_NUMBER }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.SUMMARY_ISSUE_NUMBER, 10)
            if (!Number.isInteger(issueNumber)) {
              core.setFailed('X_SUMMARY_ISSUE_NUMBER must be set to a valid issue number')
            } else {
              const fs = require('fs')
              const path = 'x-summary.txt'
              if (fs.existsSync(path)) {
                const body = fs.readFileSync(path, 'utf8')
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body,
                })
              } else {
                core.warning('x-summary.txt が存在しないため、Issue へのコメント追加をスキップしました。')
              }
            }

      - name: Show summary in logs
        if: always()
        run: |
          if [ -f x-summary.txt ]; then
            echo '✅ X自動投稿処理完了'
            echo '📄 生成された要約:'
            echo '----------------------------------------'
            cat x-summary.txt
            echo '----------------------------------------'
          else
            echo '⚠️ 要約ファイルが生成されませんでした'
