name: Daily X Auto Post

on:
  schedule:
    # æ¯æ—¥PM8:30é ƒ (JST) = PM11:30 (UTC) ã«èµ·å‹•
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§0ã€œ60åˆ†ã®ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿå¾Œã«æŠ•ç¨¿ï¼ˆå®Ÿè³ªPM8:30ã€œ9:30ã®é–“ï¼‰
    - cron: '30 11 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

jobs:
  post_to_x:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Generate X summary text
        run: node scripts/auto-post-to-x.js
        env:
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Append summary to Issue
        if: always() && vars.X_SUMMARY_ISSUE_NUMBER != ''
        uses: actions/github-script@v7
        env:
          SUMMARY_ISSUE_NUMBER: ${{ vars.X_SUMMARY_ISSUE_NUMBER }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.SUMMARY_ISSUE_NUMBER, 10)
            if (!Number.isInteger(issueNumber)) {
              core.warning('X_SUMMARY_ISSUE_NUMBER ãŒæ­£ã—ã„æ•°å€¤ã§ã¯ãªã„ãŸã‚ã€Issue ã¸ã®æŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚')
              return
            }

            const fs = require('fs')
            const path = 'x-summary.txt'
            if (!fs.existsSync(path)) {
              core.warning('x-summary.txt ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€Issue ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚')
              return
            }

            const body = fs.readFileSync(path, 'utf8')

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body,
              })
            } catch (error) {
              if (error.status === 404) {
                core.warning(`Issue #${issueNumber} ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`)
              } else {
                throw error
              }
            }

      - name: Show summary in logs
        if: always()
        run: |
          if [ -f x-summary.txt ]; then
            echo "âœ… Xã‚µãƒãƒªãƒ¼ç”Ÿæˆå®Œäº†"
            echo "ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸè¦ç´„:"
            echo "----------------------------------------"
            cat x-summary.txt
            echo "----------------------------------------"
          else
            echo "âš ï¸ è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
