name: Daily X Auto Post

on:
  # NOTE:
  # - X投稿メール送信は `X Mailer (semi-auto)` に一本化しました。
  # - ここでメールを送ると二重送信になるため、定期実行は停止しています。
  workflow_dispatch:

jobs:
  post_to_x:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: CI -> fail if NPM_CONFIG_PRODUCTION=true
        run: |
          if [ "${NPM_CONFIG_PRODUCTION:-false}" = "true" ]; then
            echo "ERROR: NPM_CONFIG_PRODUCTION=true will skip devDependencies; set NPM_CONFIG_PRODUCTION=false or use npm ci --include=dev.";
            exit 1;
          fi

      - name: Install dependencies (include dev)
        # Some scripts may rely on devDependencies; ensure they're present
        run: npm ci --include=dev

      - name: Generate X summary text
        run: node scripts/auto-post-to-x.js
        env:
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Append summary to Issue
        if: ${{ always() && vars.X_SUMMARY_ISSUE_NUMBER != '' }}
        uses: actions/github-script@v7
        env:
          SUMMARY_ISSUE_NUMBER: ${{ vars.X_SUMMARY_ISSUE_NUMBER }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.SUMMARY_ISSUE_NUMBER, 10)
            if (!Number.isInteger(issueNumber)) {
              core.warning('X_SUMMARY_ISSUE_NUMBER が正しい数値ではないため、Issue への投稿をスキップします。')
              return
            }

            const fs = require('fs')
            const path = 'x-summary.json'
            if (!fs.existsSync(path)) {
              core.warning('x-summary.json が存在しないため、Issue へのコメント追加をスキップしました。')
              return
            }

            const body = fs.readFileSync(path, 'utf8')

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body,
              })
            } catch (error) {
              if (error.status === 404) {
                core.warning(`Issue #${issueNumber} が見つからないため、コメント追加をスキップしました。`)
              } else {
                throw error
              }
            }

      - name: Show summary in logs
        if: always()
        run: |
          if [ -f x-summary.json ]; then
            echo "✅ Xサマリー生成完了"
            cat x-summary.json
          else
            echo "⚠️ 要約ファイルが生成されませんでした"
          fi
