name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (include dev)
        run: npm ci --include=dev --legacy-peer-deps

      - name: Build (production only)
        run: npm run build
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Deploy to Vercel
        run: npx vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Post-deploy health check
        if: success()
        run: |
          echo "â³ Waiting 60s for Vercel edge propagation..."
          sleep 60

          SITE_URL="https://prorenata.jp"
          echo "ğŸ” Checking $SITE_URL ..."

          # 1. HTTP status check
          HTTP_STATUS=$(curl -s -o /tmp/health_body.html -w '%{http_code}' "$SITE_URL")
          echo "HTTP Status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ FAIL: Expected HTTP 200, got $HTTP_STATUS"
            exit 1
          fi

          # 2. Content check â€” page must contain key markers
          BODY=$(cat /tmp/health_body.html)
          for MARKER in "ProReNata" "æœ€æ–°ã®è¨˜äº‹"; do
            if echo "$BODY" | grep -q "$MARKER"; then
              echo "âœ… Found: $MARKER"
            else
              echo "âŒ FAIL: Missing content marker: $MARKER"
              exit 1
            fi
          done

          # 3. Error check â€” no Server Component crash
          if echo "$BODY" | grep -q '\$RX('; then
            echo "âš ï¸  WARNING: Server Component streaming error detected (\$RX found in HTML)"
            exit 1
          fi

          echo "âœ… All health checks passed!"

      - name: Create issue on health check failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const date = new Date().toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo' });
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ [Deploy Health Check] ã‚µã‚¤ãƒˆãƒ€ã‚¦ãƒ³æ¤œå‡º (${date})`,
              body: `## ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—\n\nãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n**ã‚µã‚¤ãƒˆãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**\n\n### ç¢ºèªäº‹é …\n- https://prorenata.jp ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹\n- ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã‹\n- Server Component ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹\n\n### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°\n${context.payload.repository.html_url}/actions/runs/${context.runId}\n\n---\n**å®Ÿè¡Œæ™‚åˆ»**: ${date}`,
              labels: ['critical', 'deploy-health']
            });
