# Incident Report: ProReNata Production Downtime 2026-02-18

**Date:** 2026-02-18  
**Service:** ProReNata.jp (Frontend)  
**Severity:** Critical (Site-wide Outage)  
**Duration:** Approx. 2-3 hours (Intermittent during investigation)

## Summary
On February 18, 2026, the ProReNata.jp production website became inaccessible, displaying a "Server Components render" error. The issue was traced to the `HomePopularGrid` component crashing on Vercel due to missing local CSV files and a subsequent failure in the error handling logic.

## Impact
- **User Facing:** Users visiting the homepage encountered a full-page "Application Error" screen instead of the website content.
- **Business:** Loss of potential traffic, user engagement, and ad revenue during the downtime.

## Timeline
- **10:00 (Approx):** Deployment triggered after `yarn.lock` removal to standardise on `npm`.
- **10:10:** Site went down with "An error occurred in the Server Components render".
- **11:00-12:00:** Investigation revealed localized issue (works on local machine, fails on Vercel).
- **12:15:** Identified `HomePopularGrid` component as the source of the crash via HTML analysis (Suspense boundary failure `B:1`).
- **12:30:** Applied fix 1: Wrapped component in `<Suspense>` and made error handling robust (return `null` on crash).
- **12:35:** Site recovered, but "Popular Articles" section was missing.
- **12:45:** Identified root cause of missing section: Sanity GROQ `score()` function failure on Vercel.
- **12:55:** Applied fix 2: Implemented two-tier fallback (Try `score()` â†’ Fallback to `order(publishedAt)`).
- **13:00:** "Popular Articles" section fully restored.

## Root Cause Analysis
1.  **Direct Cause:** The `HomePopularGrid` component attempts to read local CSV files (`data/gsc_last30d.csv`) which are not committed to Git or present in the Vercel serverless environment.
2.  **Failure Chain:**
    -   When CSV read fails, the component attempts a fallback Sanity query (`fetchFallbackPosts`).
    -   This fallback query uses the experimental/complex GROQ `score()` function.
    -   On Vercel, this `score()` function call failed (likely due to API versioning or runtime constraints), throwing an error.
    -   The original `try/catch` block attempted *another* async fetch inside the `catch`, which also failed.
    -   **Critical Failure:** An unhandled error inside an async Server Component (Streaming) caused the entire page rendering to abort and trigger the global `error.tsx` boundary.

## Resolution
1.  **Isolation:** Wrapped `HomePopularGrid` in a `<Suspense>` boundary in `page.tsx`. This ensures that even if the component crashes, the rest of the page (Header, Latest Articles, Footer) continues to render.
2.  **Robust Error Handling:** Modified `HomePopularGrid` to strictly return `null` if all data fetching fails, rather than throwing an error.
3.  **Reliable Fallback:** Implemented a `safeFetchFallbackPosts` wrapper with a two-tier strategy:
    -   **Tier 1:** Attempt the sophisticated `score()` query.
    -   **Tier 2:** If Tier 1 fails, fall back to a simple, guaranteed-to-work `order(publishedAt)` query.

## Prevention & Action Items
-   [x] **Code Safety:** Ensure all async Server Components are wrapped in `<Suspense>` or have comprehensive `try/catch` blocks that never throw.
-   [x] **Dependency Management:** Standardized on `npm` (removed `yarn.lock`) to avoid dependency resolution conflicts.
-   [ ] **Testing:** Verify Vercel Preview deployments specifically for "missing data" scenarios (e.g., maintain a "Chaos Mode" config that simulates missing CSVs locally).
-   [ ] **Monitoring:** Set up Vercel Logs or Sentry to alert on "Server Component render" errors immediately.
